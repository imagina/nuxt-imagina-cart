<script setup lang="ts">



const store = useAuthStore()
const emit = defineEmits(['logged'])

const state = reactive({
  success: true,
  loading: false,
})

onMounted(() => {
  init()
})

const clientIdGoogle = computed(() => getSetting('isite::googleClientId'))

async function addCDN() {
  const script = document.createElement('script');
  script.async = true;
  script.src = 'https://accounts.google.com/gsi/client';
  script.onload = () => {
    loadClientId()
  }; 
  document.body.appendChild(script);
}

//Load Client ID
async function loadClientId() {
  setTimeout(() => {
    let clientId = clientIdGoogle.value || null
    if (!clientId) return
    try {
      if(google){
        google.accounts.id.initialize({
          client_id: clientId,
          callback: (response) => {
            login(response)
          },
          scope: 'profile email openid',
          cancel_on_tap_outside: false,
          context: 'use',
        })

        google.accounts.id.renderButton(
          document.getElementById("googleButton"),
          {theme: "outline", size: "large"}
        );
        // Initialize Google Identity Services    
        google.accounts.id.prompt(); // also display the One Tap dialog
      }
    } catch (error) {
      console.count('loadClientId')
      loadClientId()
      console.log(error)
    }    
  }, 800)
}

async function init(){
  await store.getSettings()
  addCDN()
}
//SignIn method
async function signIn(response) {
  google.accounts.id.prompt()
}
//Request Login
async function login(response) {
  if (response?.credential) {
    let token = response.credential
    store
      .authSocialNetwork({
        token,
        type: 'google',
      })
      .then((response) => {
        state.loading = false
        emit('logged')
      })
  }
}
</script>

<template>
  <div
    v-if="clientIdGoogle"
    id="googleButton"
  >
  </div>
</template>
